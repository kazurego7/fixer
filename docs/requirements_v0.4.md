# 要件定義 v0.4（GitHub連携＋Codex App Server スマホUI）

## 0. 背景と狙い
- Codex（Web）は応答が遅く、CI/CD待ちも挟まって確認が遅い
- ローカルのCodexは速いが、スマホからSSHでCLI操作するのが不便
- そこで、ローカルで動かす Codex App Server に対し、スマホで入力と出力を扱えるWeb UIを用意して、確認ループを短くする
- diffは「Codexが出力に含めるなら表示」。UI側でGit diffを生成しない

## 1. ゴール
- スマホで「指示 → 出力確認 → 追指示」を快適に回せる
- ローカル環境でCodexを回し、WebやCI/CD待ちを避ける

## 2. スコープ

### 2.1 作るもの
- Codex App Server と通信するスマホ向けWeb UI
- GitHub連携によるリポジトリ一覧取得
- リポジトリのローカルクローン
- リポジトリにひもづくセッション（Thread）一覧表示・開始・再開
- 1送信＝1ターンで実行し、出力をストリーミング表示
- 実行の停止（キャンセル）
- Codex出力に含まれるMarkdownのレンダリング
- Codexが返すdiff/patchの表示（返ってきた場合のみ）
- 画像貼り付け／画像アップロード（Codex入力として可能な範囲で）
- 承認要求（コマンド実行・ファイル変更など）が出た場合の承認UI

### 2.2 作らないもの
- UI側でdiffを生成する機能（Git diff取得・差分計算）
- IDE相当の編集機能、ブランチ運用、マージ支援
- CI/CD連携

## 3. 機能要件

### 3.1 リポジトリ管理（GitHub連携）
- GitHubからアクセス可能なリポジトリ一覧を取得し、UIに表示できる
- リポジトリ一覧で検索（名前など）ができる
- リポジトリを選択できる

### 3.2 ローカルクローン
- 選択したリポジトリをローカルにクローンできる
- クローン先は「ワークスペースのルート配下」に統一する
- クローン状態が分かる（未クローン／クローン中／クローン済み／失敗）
- 既にクローン済みの場合は再利用できる（重複クローンしない）

### 3.3 セッション（Thread）
- 選択したリポジトリ（ローカルパス）に対し、そのリポジトリにひもづくセッション一覧を全件取得して表示できる
- 新規セッションを開始できる
- 既存セッションを開いて再開できる
- セッションIDをUIで確認できる

### 3.4 実行（Turn）
- 送信1回を1ターンとして扱う
- ターンの出力をストリーミングで表示できる
- 実行中ターンを停止（キャンセル）できる
- 承認要求が出た場合、UIで承認／拒否／キャンセルができる

### 3.5 表示（出力）
- Codex出力がMarkdownとして解釈できる場合、読みやすくレンダリングする
  - コードブロックは崩さない
- Markdownとして扱えない場合はプレーンテキスト表示にフォールバックする
- Codex出力にdiff/patch/unified diffが含まれる場合、それを崩さず表示する
  - UI側で差分生成はしない

### 3.6 添付（入力）
- 画像を入力として送れる（アップロード／貼り付けは可能な範囲で）
- 一般ファイル添付は「Codex App Server の入力として扱える範囲で」対応する
  - できない場合はMVP外（無理に実現しない）

## 4. 画面要件（最小）
1. リポジトリ一覧（GitHubから取得、検索、選択）
2. クローン状態表示（必要ならクローン実行）
3. セッション一覧（選択リポジトリにひもづくThreadを全件表示、新規開始）
4. チャット画面（入力、添付、送信、停止、ストリーミング出力、diff表示、承認）

## 5. 非機能要件（最低限）
- スマホで読みやすいUI（自動スクロールのON/OFF、コピーしやすさ）
- 通信切断時に画面を更新して復帰できる（セッションを開き直せる）
- ローカルで起動・運用できる（構成が複雑になりすぎない）

## 6. 受け入れ基準（MVP完了条件）
- スマホからUIへアクセスできる
- GitHubからリポジトリ一覧を取得して表示でき、検索して選べる
- 選んだリポジトリをローカルにクローンできる（状態が見える）
- そのリポジトリにひもづくセッション一覧を全件表示できる
- 新規／既存セッションで送信でき、出力がストリーミング表示される
- 実行中に停止（キャンセル）できる
- Markdownが読みやすく表示され、コードブロックが崩れない
- Codexがdiffを返した場合に表示できる（UI側で生成しない）
- 画像入力を送れる（可能な範囲で）

## 7. 実装メモ（MVP推奨）
- API接続は、`repository`, `thread`, `turn`, `approval` の責務単位で分離する
- ストリーミングはSSEまたはWebSocketどちらかに統一し、再接続戦略を先に決める
- スマホUIは1カラム構成を基本にし、下部固定の入力エリアを採用する
- diff/patchは専用の等幅フォント領域にそのまま表示し、加工しない
